<html>
<head>
  <title>Do I need an Umbrella?</title>
</head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<style>

  body {
    font-family: sans-serif;
    text-align: center;
  }

  h1 {
    font-size: 40px;
  }

  #postcode_form {
    width: 100%;
  }

  #postcode {
    font-size: 80px;
    text-align: center;
    height: 2em;
    width: 6em;
  }

  #postcode.error {
    background-color: pink;
    color: red;
  }

  #postcode.hidden {
    display: none;
  }

  #answer {
    font-size: 80px;
    height: 2em;
  }

  #umbrella_icon {
    font-size: 200px;
  }

  #location #admin_ward {
    font-size: 42px;
  }

  #location #forecast_site {
    font-size: 28px;
    color: grey;
    margin-left: 10px;
  }

</style>
<body>

  <h1>Do I need an Umbrella?</h1>

  <div id="answer">
    <p><i id="umbrella_icon"></i></p>
    <p id="umbrella_text"></p>
    <p id="location">
      <span id="admin_ward"></span>
      <span id="forecast_site"></span>
    </p>
  </div>

  <form id="postcode_form">
    <input type="text" name="postcode" id="postcode" placeholder="SW1 1AB">
  </form>

  <script src="../../dist/browser/datapoint.js"></script>
  <script>

    /** Listen for form submit and call get_location() with the entered postcode */
    document.getElementById("postcode_form").addEventListener("submit", function(e){
      e.preventDefault();
      get_location(document.getElementById("postcode").value);
    });

    /** Convert a postcode into longitude and latitude and call get_weather() */
    function get_location(postcode){
      var xhttp = new XMLHttpRequest();
      var url = "http://api.postcodes.io/postcodes/" + postcode;
      xhttp.onreadystatechange = function() {
          if (xhttp.readyState == 4){
            if (xhttp.status == 200) {
              var response = JSON.parse(xhttp.responseText);
              document.getElementById("admin_ward").innerHTML = response.result.admin_ward;
              document.getElementById("postcode").className = "hidden";
              console.log(response.result);
              get_weather(response.result.longitude, response.result.latitude);
            } else {
              console.log("Postcode lookup failed");
              console.log(xhttp.responseText);
              document.getElementById("postcode").className = "error";
            }
          }
      }
      xhttp.open("GET", url, true);
      xhttp.send();
    }

    /** Get weather forecast for longitude and latitude and call decide_on_umbrella() */
    function get_weather(longitude, latitude){
      datapoint.set_key("aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee");
      var site = datapoint.get_nearest_site(longitude, latitude);
      document.getElementById("forecast_site").innerHTML = "(" + site.name + ")";
      var forecast = datapoint.get_forecast_for_site(site.id);
      var current_timestep = forecast.days[0].timesteps[0];
      decide_on_umbrella(current_timestep.precipitation.value);
    }

    /** Decide if you need an umbrella and call display_umbrella() */
    function decide_on_umbrella(precipitation){
      var need_umbrella = precipitation > 40;
      display_umbrella(need_umbrella);
    }

    /** Manipulate the DOM to display whether you need an umbrella */
    function display_umbrella(need_umbrella){
      if(need_umbrella){
        document.getElementById("umbrella_text").innerHTML = "You should take an umbrella!";
        document.getElementById("umbrella_icon").className = "fa fa-umbrella";
      } else {
        document.getElementById("umbrella_text").innerHTML = "You don't need an umbrella today!"
        document.getElementById("umbrella_icon").className = "fa fa-sun-o";
      }
    }

  </script>
</body>
</html>
